# VerdantTech Database Changes: Version 1.0 to Version 2.0

## üìä T·ªïng quan thay ƒë·ªïi
- **T·ªïng s·ªë b·∫£ng V1**: 31 b·∫£ng
- **T·ªïng s·ªë b·∫£ng V2**: 22 b·∫£ng
- **B·∫£ng b·ªã x√≥a**: 11 b·∫£ng
- **B·∫£ng m·ªõi th√™m**: 2 b·∫£ng
- **B·∫£ng ƒë∆∞·ª£c ch·ªânh s·ª≠a**: 12 b·∫£ng

---

## üóëÔ∏è C√ÅC B·∫¢NG ƒê√É X√ìA (11 b·∫£ng)

### 1. `knowledge_base`
- **L√Ω do**: Theo y√™u c·∫ßu x√≥a b·∫£ng

### 2. `plant_disease_detections`
- **L√Ω do**: Theo y√™u c·∫ßu x√≥a b·∫£ng

### 3. `blog_posts`
- **L√Ω do**: X√≥a to√†n b·ªô h·ªá th·ªëng blog

### 4. `blog_comments`
- **L√Ω do**: X√≥a to√†n b·ªô h·ªá th·ªëng blog

### 5. `user_interactions`
- **L√Ω do**: Theo y√™u c·∫ßu x√≥a b·∫£ng

### 6. `educational_materials`
- **L√Ω do**: Theo y√™u c·∫ßu x√≥a b·∫£ng

### 7. `user_activity_logs`
- **L√Ω do**: Theo y√™u c·∫ßu x√≥a b·∫£ng

### 8. `sales_analytics_daily`
- **L√Ω do**: Theo y√™u c·∫ßu x√≥a b·∫£ng

### 9. `system_settings`
- **L√Ω do**: Theo y√™u c·∫ßu x√≥a b·∫£ng

### 10. `audit_logs`
- **L√Ω do**: Theo y√™u c·∫ßu x√≥a b·∫£ng

### 11. Sample data inserts
- **L√Ω do**: B·ªè ph·∫ßn th√™m d·ªØ li·ªáu m·∫´u

---

## ‚ûï C√ÅC B·∫¢NG M·ªöI TH√äM (2 b·∫£ng)

### 1. `cart` - Gi·ªè h√†ng
```sql
CREATE TABLE cart (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL,
    product_id BIGINT UNSIGNED NOT NULL,
    quantity INT NOT NULL DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_product (user_id, product_id)
);
```

### 2. `fertilizers` - Theo d√µi s·ª≠ d·ª•ng ph√¢n b√≥n
```sql
CREATE TABLE fertilizers (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    environmental_data_id BIGINT UNSIGNED NOT NULL,
    organic_fertilizer DECIMAL(10,2) DEFAULT 0.00 COMMENT 'Ph√¢n h·ªØu c∆° (kg)',
    npk_fertilizer DECIMAL(10,2) DEFAULT 0.00 COMMENT 'Ph√¢n NPK t·ªïng h·ª£p (kg)',
    urea_fertilizer DECIMAL(10,2) DEFAULT 0.00 COMMENT 'Ph√¢n ur√™ (kg)', 
    phosphate_fertilizer DECIMAL(10,2) DEFAULT 0.00 COMMENT 'Ph√¢n l√¢n (kg)',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (environmental_data_id) REFERENCES environmental_data(id) ON DELETE CASCADE
);
```

### 3. `energy_usage` - Theo d√µi s·ª≠ d·ª•ng nƒÉng l∆∞·ª£ng
```sql
CREATE TABLE energy_usage (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    environmental_data_id BIGINT UNSIGNED NOT NULL,
    electricity_kwh DECIMAL(10,2) DEFAULT 0.00 COMMENT 'ƒêi·ªán ti√™u th·ª• (kWh)',
    gasoline_liters DECIMAL(10,2) DEFAULT 0.00 COMMENT 'XƒÉng s·ª≠ d·ª•ng (l√≠t)',
    diesel_liters DECIMAL(10,2) DEFAULT 0.00 COMMENT 'D·∫ßu diesel s·ª≠ d·ª•ng (l√≠t)',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (environmental_data_id) REFERENCES environmental_data(id) ON DELETE CASCADE
);
```

---

## ‚úèÔ∏è C√ÅC B·∫¢NG ƒê√É CH·ªàNH S·ª¨A

### 1. `users` - B·∫£ng ng∆∞·ªùi d√πng

#### **Thay ƒë·ªïi ENUM role:**
- **Tr∆∞·ªõc (V1)**: `ENUM('customer', 'farmer', 'seller', 'vendor', 'admin', 'expert', 'content_manager')`
- **Sau (V2)**: `ENUM('customer', 'seller', 'admin', 'manager')`
- **L√Ω do**: G·ªôp customer + farmer th√†nh customer, ƒë∆°n gi·∫£n h√≥a roles

#### **X√≥a field:**
- **Field b·ªã x√≥a**: `language_preference ENUM('vi', 'en') DEFAULT 'vi'`
- **L√Ω do**: Theo y√™u c·∫ßu b·ªè field n√†y

### 2. `products` - B·∫£ng s·∫£n ph·∫©m

#### **ƒê·ªïi t√™n field:**
- **Tr∆∞·ªõc**: `sku VARCHAR(100) UNIQUE NOT NULL`
- **Sau**: `product_code VARCHAR(100) UNIQUE NOT NULL`
- **Index c≈©**: `INDEX idx_sku (sku)`
- **Index m·ªõi**: `INDEX idx_product_code (product_code)`

#### **X√≥a field:**
- **Field b·ªã x√≥a**: `min_order_quantity INT DEFAULT 1`
- **L√Ω do**: Theo y√™u c·∫ßu b·ªè field n√†y

### 3. `orders` - B·∫£ng ƒë∆°n h√†ng

#### **X√≥a c√°c field:**
- **Fields b·ªã x√≥a**:
  - `currency_code VARCHAR(3) DEFAULT 'VND'`
  - `billing_address JSON`
  - `order_number VARCHAR(50) UNIQUE NOT NULL`
- **Index b·ªã x√≥a**: `INDEX idx_order_number (order_number)`
- **L√Ω do**: H·ªá th·ªëng thu·∫ßn Vi·ªát Nam, kh√¥ng c·∫ßn currency v√† billing address

### 4. `order_items` ‚Üí `order_details` - ƒê·ªïi t√™n b·∫£ng

#### **ƒê·ªïi t√™n b·∫£ng:**
- **Tr∆∞·ªõc**: `order_items`
- **Sau**: `order_details`

#### **X√≥a c√°c field:**
- **Fields b·ªã x√≥a**:
  - `product_name VARCHAR(255) NOT NULL COMMENT 'Snapshot of product name'`
  - `product_sku VARCHAR(100) NOT NULL COMMENT 'Snapshot of SKU'`
  - `specifications JSON COMMENT 'Snapshot of product specs'`
- **L√Ω do**: ƒê∆°n gi·∫£n h√≥a c·∫•u tr√∫c, l·∫•y th√¥ng tin t·ª´ product_id

### 5. `payments` - B·∫£ng thanh to√°n

#### **X√≥a field:**
- **Field b·ªã x√≥a**: `currency_code VARCHAR(3) DEFAULT 'VND'`
- **L√Ω do**: H·ªá th·ªëng thu·∫ßn Vi·ªát Nam

### 6. `product_reviews` - B·∫£ng ƒë√°nh gi√° s·∫£n ph·∫©m

#### **X√≥a c√°c field:**
- **Fields b·ªã x√≥a**:
  - `is_verified_purchase BOOLEAN DEFAULT TRUE`
  - `vendor_reply TEXT`
  - `vendor_replied_at TIMESTAMP NULL`
  - `is_featured BOOLEAN DEFAULT FALSE`
  - `status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending'`
  - `moderated_by BIGINT UNSIGNED NULL`
  - `moderated_at TIMESTAMP NULL`
- **Foreign key b·ªã x√≥a**: `FOREIGN KEY (moderated_by) REFERENCES users(id)`
- **Index b·ªã x√≥a**: `INDEX idx_status (status)`

### 7. `farm_profiles` - H·ªì s∆° n√¥ng tr·∫°i

#### **X√≥a c√°c field:**
- **Fields b·ªã x√≥a**:
  - `farming_experience_years INT`
  - `certification_types JSON COMMENT 'Array of certifications like organic, VietGAP, GlobalGAP'`
  - `soil_type VARCHAR(100)` (chuy·ªÉn sang environmental_data)
  - `irrigation_type VARCHAR(100)`

#### **Thay ƒë·ªïi v·ªã tr√≠:**
- **Di chuy·ªÉn**: T·ª´ v·ªã tr√≠ sau `users` xu·ªëng c·∫°nh `environmental_data` trong file schema

### 8. `environmental_data` - D·ªØ li·ªáu m√¥i tr∆∞·ªùng

#### **Th√™m field m·ªõi:**
- **Field m·ªõi**: `soil_type ENUM('ƒê·∫•t ph√π sa', 'ƒê·∫•t ƒë·ªè Bazan', 'ƒê·∫•t Feralit', 'ƒê·∫•t th·ªãt', 'ƒê·∫•t s√©t', 'ƒê·∫•t c√°t') NOT NULL`
- **Index m·ªõi**: `INDEX idx_soil_type (soil_type)`

#### **X√≥a c√°c field:**
- **Fields b·ªã x√≥a**:
  - `nitrogen_level DECIMAL(10,2) COMMENT 'N content in mg/kg'`
  - `phosphorus_level DECIMAL(10,2) COMMENT 'P content in mg/kg'`
  - `potassium_level DECIMAL(10,2) COMMENT 'K content in mg/kg'`
  - `organic_matter_percentage DECIMAL(5,2)`

### 9. `chatbot_messages` - Tin nh·∫Øn chatbot

#### **X√≥a c√°c field:**
- **Fields b·ªã x√≥a**:
  - `intent VARCHAR(100) COMMENT 'Detected user intent'`
  - `entities JSON COMMENT 'Extracted entities from message'`
  - `confidence_score DECIMAL(3,2) COMMENT 'AI confidence score'`
  - `suggested_actions JSON COMMENT 'Quick reply suggestions'`

### 10. `forum_categories` - Danh m·ª•c di·ªÖn ƒë√†n

#### **X√≥a c√°c field:**
- **Fields b·ªã x√≥a**:
  - `name_en VARCHAR(255)`
  - `slug VARCHAR(255) UNIQUE NOT NULL`
  - `icon_url VARCHAR(500)`
  - `sort_order INT DEFAULT 0`
- **Indexes b·ªã x√≥a**:
  - `INDEX idx_slug (slug)`
  - `INDEX idx_active_sort (is_active, sort_order)`
- **Index c√≤n l·∫°i**: `INDEX idx_active (is_active)`

### 11. `forum_posts` - B√†i vi·∫øt di·ªÖn ƒë√†n

#### **Th√™m field m·ªõi:**
- **Field m·ªõi**: `image_link VARCHAR(500)`

### 12. `forum_comments` - B√¨nh lu·∫≠n di·ªÖn ƒë√†n

#### **X√≥a field:**
- **Field b·ªã x√≥a**: `is_solution BOOLEAN DEFAULT FALSE`

---

## üîß C√ÅC TRIGGER ƒê√É CH·ªàNH S·ª¨A

### Trigger `update_product_rating_on_update`
- **Thay ƒë·ªïi**: B·ªè ƒëi·ªÅu ki·ªán `AND status = 'approved'` v√¨ ƒë√£ x√≥a field `status` trong `product_reviews`
- **Tr∆∞·ªõc**: 
  ```sql
  WHERE product_id = NEW.product_id AND status = 'approved'
  ```
- **Sau**: 
  ```sql
  WHERE product_id = NEW.product_id
  ```

---

## üìà T·ªîNG K·∫æT TH·ªêNG K√ä

### Theo lo·∫°i thay ƒë·ªïi:
- **Fields b·ªã x√≥a**: 24 fields
- **Fields ƒë∆∞·ª£c th√™m**: 8 fields  
- **Fields ƒë·ªïi t√™n**: 1 field
- **B·∫£ng ƒë·ªïi t√™n**: 1 b·∫£ng
- **Enum ƒë∆∞·ª£c s·ª≠a**: 1 enum
- **Indexes b·ªã x√≥a**: 6 indexes
- **Indexes ƒë∆∞·ª£c th√™m**: 2 indexes
- **Foreign keys b·ªã x√≥a**: 1 foreign key
- **Triggers ƒë∆∞·ª£c s·ª≠a**: 2 triggers

### M·ª•c ƒë√≠ch ch√≠nh c·ªßa c√°c thay ƒë·ªïi:
1. **ƒê∆°n gi·∫£n h√≥a**: Gi·∫£m complexity b·∫±ng c√°ch x√≥a c√°c features kh√¥ng c·∫ßn thi·∫øt
2. **T·ªëi ∆∞u cho th·ªã tr∆∞·ªùng VN**: B·ªè multi-currency, multi-language
3. **T·∫≠p trung core features**: Gi·ªØ l·∫°i ecommerce, environmental tracking, forum
4. **C·∫£i thi·ªán UX**: Th√™m shopping cart, ƒë∆°n gi·∫£n h√≥a product management

### C√°c b·∫£ng quan tr·ªçng ƒë∆∞·ª£c gi·ªØ l·∫°i v√† t·ªëi ∆∞u:
- ‚úÖ User management (simplified roles)
- ‚úÖ Product & inventory management  
- ‚úÖ Order & payment processing
- ‚úÖ Environmental data tracking (enhanced)
- ‚úÖ AI Chatbot functionality
- ‚úÖ Community forum features